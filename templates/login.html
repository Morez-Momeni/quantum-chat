<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ورود | {{ username }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00d4ff; --bg: #0a0a1e; --card: rgba(20,20,40,0.7); --text: #e0e7ff; --error: #ff6b6b; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .login-card { background: var(--card); backdrop-filter: blur(12px); border-radius: 20px; padding: 2rem; width: 100%; max-width: 400px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08); text-align: center; }
        h1 { font-size: 1.8rem; margin-bottom: 1.5rem; background: linear-gradient(90deg, var(--primary), #7c3aed); -webkit-background-clip: text; color: transparent; }
        form { display: flex; flex-direction: column; gap: 1rem; }
        input { padding: 0.9rem 1.2rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; border-radius: 12px; font-size: 1rem; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,212,255,0.2); }
        button { padding: 0.9rem; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        button:hover { background: #00b0d4; transform: translateY(-2px); }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
        .error { color: var(--error); margin-top: 0.5rem; font-size: 0.9rem; min-height: 1.2rem; }
    </style>
</head>
<body>
    <div class="login-card">
        <h1>سلام {{ username }}!</h1>
        <form id="loginForm">
            <input type="password" id="password" placeholder="رمز عبور..." required />
            <button type="submit" id="loginBtn">ورود به چت</button>
            <p class="error" id="error"></p>
        </form>
    </div>

<script>
    const form = document.getElementById("loginForm");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const error = document.getElementById("error");

    let rawUsername = "{{ username }}".trim();
    const cleanUsername = rawUsername
        .replace(/[^a-zA-Z0-9آ-ی\u0600-\u06FF\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim();

    if (!cleanUsername) {
        alert("نام کاربری نامعتبر!");
        window.location.href = "/";
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const password = passwordInput.value.trim();
        if (!password) return;

        loginBtn.disabled = true;
        loginBtn.textContent = "در حال ورود...";
        error.textContent = "";

        try {
            const res = await fetch(`/login/${encodeURIComponent(cleanUsername)}`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `password=${encodeURIComponent(password)}`
            });

            const data = await res.json();

            if (data.success) {
                localStorage.setItem("username", cleanUsername); // ذخیره تمیز
                window.location.href = "/chat";
            } else {
                error.textContent = data.error || "رمز اشتباه است!";
                loginBtn.disabled = false;
                loginBtn.textContent = "ورود به چت";
            }
        } catch (err) {
            error.textContent = "خطا در اتصال";
            loginBtn.disabled = false;
            loginBtn.textContent = "ورود به چت";
        }
    });

    passwordInput.focus();
</script>
</body>
</html>

