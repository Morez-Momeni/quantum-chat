<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Terminal // SELECT USER</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
    :root {
        --green: #0f0;
        --cyan: #00eaff;
        --bg: #000;
        --text: #08f708;
        --border: #0f0;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
        margin: 0;
        background: #000;
        color: var(--text);
        font-family: "Vazirmatn", monospace;
        height: 100vh;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 1.5s ease-out;
        position: relative;
    }

    /* === MATRIX RAIN BACKGROUND === */
    #matrix-canvas {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: 1;
        pointer-events: none;
    }

    /* === CRT + Noise === */
    .crt::before {
        content: ""; position: fixed; top:0; left:0; width:100%; height:100%;
        background: repeating-linear-gradient(0deg, rgba(0,255,0,0.03), rgba(0,255,0,0.03) 1px, transparent 1px, transparent 2px);
        pointer-events: none; z-index: 9998;
    }
    .crt::after {
        content: ""; position: fixed; top:0; left:0; width:100%; height:100%;
        background: url('https://i.imgur.com/8QfQqVY.png') repeat;
        opacity: 0.04; mix-blend-mode: screen;
        pointer-events: none; z-index: 9999;
        animation: noise 0.2s steps(8) infinite;
    }
    @keyframes noise { 0% { transform:translate(0,0); } 100% { transform:translate(2px,2px); } }

    .terminal {
        background: rgba(0,0,0,0.9);
        border: 3px solid var(--green);
        width: 92%;
        max-width: 900px;
        padding: 35px;
        box-shadow: 0 0 50px #0f0, inset 0 0 40px rgba(0,255,0,0.15);
        position: relative;
        z-index: 10;
        text-shadow: 0 0 10px #0f0;
        animation: glow 4s infinite alternate;
    }
    @keyframes glow {
        0% { box-shadow: 0 0 40px #0f0; }
        100% { box-shadow: 0 0 80px #0f0; }
    }

    .header {
        color: var(--green);
        font-size: 2rem;
        text-align: center;
        margin-bottom: 20px;
        letter-spacing: 4px;
        text-shadow: 0 0 25px #0f0;
        animation: glitch 6s infinite;
    }
    @keyframes glitch {
        0%,100% { text-shadow: 0 0 25px #0f0; }
        2% { text-shadow: 4px 4px #f00, -4px -4px #0ff; }
        4% { text-shadow: -4px -4px #f00, 4px 4px #0ff; }
    }

    .status-bar {
        color: #0b0;
        font-size: 0.9rem;
        text-align: center;
        margin: 15px 0;
        letter-spacing: 1px;
    }

    .typing {
        color: var(--cyan);
        overflow: hidden;
        white-space: nowrap;
        border-right: 3px solid var(--green);
        animation: typing 4s steps(40) infinite, blink 0.8s infinite;
    }
    @keyframes typing {
        0% { width: 0; }
        50% { width: 100%; }
        100% { width: 100%; }
    }

    .users-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 25px;
        margin-top: 40px;
    }

    .user-card {
        background: rgba(0,30,0,0.5);
        border: 1px solid var(--green);
        padding: 25px;
        text-align: center;
        cursor: pointer;
        transition: all 0.4s;
        position: relative;
        overflow: hidden;
    }
    .user-card::before {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(0,255,0,0.3), transparent);
        transition: 0.7s;
    }
    .user-card:hover::before { left: 100%; }

    .user-card:hover {
        background: rgba(0,80,0,0.7);
        transform: translateY(-12px) scale(1.08);
        box-shadow: 0 0 40px #0f0;
        border-color: var(--cyan);
    }

    .avatar {
        width: 90px;
        height: 90px;
        background: var(--green);
        color: #000;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0 auto 18px;
        box-shadow: 0 0 30px #0f0;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%,100% { box-shadow: 0 0 25px #0f0; }
        50% { box-shadow: 0 0 50px #0f0; }
    }

    .username {
        color: var(--cyan);
        font-weight: bold;
        font-size: 1.4rem;
        letter-spacing: 2px;
    }

    .cursor {
        display: inline-block;
        width: 12px;
        height: 24px;
        background: var(--green);
        margin-left: 6px;
        animation: blink 0.8s infinite;
    }
    @keyframes blink { 0%,50% { opacity:1 } 51%,100% { opacity:0 } }
</style>
</head>
<body class="crt">

<canvas id="matrix-canvas"></canvas>

<div class="terminal">
    <div class="header">T E R M I N A L</div>
    
    <div class="status-bar">
        [NODE] IP: <span id="ip">---.---.---.---</span> | PORT: <span id="port">443</span> | TIME: <span id="time">--:--:--</span>
    </div>
    
    <div class="status-bar">
        <span class="typing">سه تفنگدار + ۱ — انتخاب هویت برای ورود به سیستم </span>
    </div>

    <div class="users-grid">
        {% for friend in friends %}
        <div class="user-card" onclick="selectUser('{{ friend }}')">
            <div class="avatar">{{ friend[0] }}</div>
            <div class="username">{{ friend }}</div>
            <div style="color:#0b0; margin-top:10px; font-size:0.9rem;">[READY]</div>
        </div>
        {% endfor %}
    </div>

    <div style="text-align:center; margin-top:35px; color:#080;">
        <small>[SYSTEM] روی هویت مورد نظر کلیک کنید <span class="cursor"></span></small>
    </div>
</div>

<script>
    // === MATRIX RAIN ===
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const matrix = "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%+-/~{[|`]}";
    const fontSize = 16;
    const columns = canvas.width / fontSize;
    const drops = Array(Math.floor(columns)).fill(1);

    function drawMatrix() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0f0';
        ctx.font = fontSize + 'px monospace';

        for (let i = 0; i < drops.length; i++) {
            const text = matrix[Math.floor(Math.random() * matrix.length)];
            ctx.fillText(text, i * fontSize, drops[i] * fontSize);

            if (drops[i] * fontSize > canvas.height && Math.random() > 0.975)
                drops[i] = 0;

            drops[i]++;
        }
    }
    setInterval(drawMatrix, 35);

    fetch('https://api.ipify.org?format=json')
        .then(r => r.json())
        .then(data => document.getElementById('ip').textContent = data.ip)
        .catch(() => document.getElementById('ip').textContent = '192.168.88.1');

    document.getElementById('port').textContent = location.port || (location.protocol === 'https:' ? '443' : '80');

    function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('fa-IR');
        document.getElementById('time').textContent = timeStr;
    }
    updateTime();
    setInterval(updateTime, 1000);

    // === صدای کلیک هکری ===
    const clickSound = new Audio('https://cdn.freesound.org/previews/267/267299_5123853-lq.mp3');
    clickSound.volume = 0.2;

    function selectUser(username) {
        clickSound.currentTime = 0;
        clickSound.play().catch(() => {});

        const card = event.currentTarget;
        card.innerHTML = `
            <div style="color:#0f0; font-size:1.2rem;">[ACCESSING USER]</div>
            <div style="color:#00eaff; margin:10px 0;">${username}</div>
            <div style="color:#0f0;">[GRANTED]</div>
        `;

        setTimeout(() => {
            document.body.style.opacity = '0';
            setTimeout(() => {
                window.location.href = `/login/${encodeURIComponent(username)}`;
            }, 700);
        }, 1200);
    }

    // بوت انیمیشن
    window.addEventListener('load', () => {
        setTimeout(() => {
            document.body.style.opacity = '1';
        }, 800);
    });

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
</script>
</body>
</html>
